{"pageProps":{"meta":{"title":"Mac上如何开机与关机时自动运行Shell脚本","date":"2020-11-24 08:00","tags":["shell"],"categories":"工具","description":"Mac上如何开机与关机时自动运行Shell脚本","keywords":"Mac, shell, 自动化, 脚本"},"content":"\r\n网上讲如何开机运行脚本的很多，但我有关机时关闭远程服务的需求。于是上外网查了一下如何在关机时执行一段脚本。\r\n\r\n## 新建一个shell文件\r\n\r\n这个shell中包含了你需要开机关机时运行的脚本。\r\n\r\n```bash\r\n#!/bin/bash\r\nfunction shutdown()\r\n{\r\n\r\n  # 关机用的脚本放这里\r\n\r\n  exit 0\r\n}\r\n\r\nfunction startup()\r\n{\r\n\r\n  # 开机用的脚本放这里\r\n\r\n  tail -f /dev/null &\r\n  wait $!\r\n}\r\n\r\ntrap shutdown SIGTERM\r\ntrap shutdown SIGKILL\r\n\r\nstartup;\r\n```\r\n\r\n以上文件我取名为launchdeamon，赋予了当前用户的执行权限。\r\n\r\n```shell\r\nchmod 755 launchdaemon\r\n```\r\n\r\n## 新建plist文件\r\n\r\n为了让launchdeamon能在开机时自动运行，需要编写一个相应plist文件，使用launctl做到开机启动。关于launchctl和plist的作用，请先查看这篇文章：[Mac执行定时任务之launchctl](https://www.jianshu.com/p/b65c1d339eec)。\r\n\r\nplist文件的内容如下：\r\n\r\n```xml\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">\r\n<plist version=\"1.0\">\r\n<dict>\r\n<key>Label</key><string>boot-shutdown</string>\r\n\r\n<key>ProgramArguments</key>\r\n<array>\r\n  <string>$SCRIPT_PATH/launchdaemon</string>\r\n</array>\r\n\r\n<key>RunAtLoad</key>\r\n<true/>\r\n\r\n<key>StandardOutPath</key>\r\n<string>$LOG_PATH/boot-shutdown.log</string>\r\n\r\n<key>StandardErrorPath</key>\r\n<string>$PLOG_PATH/boot-shutdown.err</string>\r\n\r\n</dict>\r\n</plist>\r\n```\r\n\r\nplist文件以键值对的形式存储信息。以上文件的字段解释：\r\n\r\n- `Label`：标签，也就是运行该plist显示的名字。这里为boot-shutdown\r\n- `ProgramArguments`：`array`里可以存放多个需要运行程序。这里的`$SCRIPT_PATH`请自己修改。\r\n- `RunAtLoad`：开机自启，为`true`\r\n- `StandardOutPath`：打印标准输出到某个文件，方便查看程序后台运行的结果，`$LOG_PATH`自行修改。\r\n- `StandardErrorPath`：打印标准错误到某个文件，同上。\r\n\r\n以上文件我取名为 boot-shutdown-script.plist 。\r\n\r\n由于shell脚本的执行权限是当前用户，以上文件需要放入当前用户的开机启动文件夹，即为 ~/Library/LaunchAgents 。\r\n\r\n然后将plist文件加入开启启动：\r\n\r\n```\r\nlaunchctl load ~/Library/LaunchAgents/boot-shutdown-script.plist\r\n```\r\n\r\n此时重启后，可以使用以下命令查看脚本运行状态\r\n\r\n```shell\r\nlaunchctl list | grep boot\r\n```\r\n\r\n输出为\r\n\r\n```\r\n438\t0\tboot-shutdown\r\n```\r\n\r\n第一个是pid。第二个为状态码，为0说明正常运行中。\r\n\r\n------\r\n\r\n参考：\r\n\r\n- [Run a script only at shutdown (not log off or restart) on Mac OS X](https://stackoverflow.com/questions/24200924/run-a-script-only-at-shutdown-not-log-off-or-restart-on-mac-os-x)","excerpt":" 网上讲如何开机运行脚本的很多，但我有关机时关闭远程服务的需求。于是上外网查了一下如何在关机时执行一段脚本。  ## 新建一个shell文件  这个shell中包含了你需要开机关机时运行的脚本。  ```bash #!/bin/bash function shutdown() {    ","prevPost":{"title":"关于指针与Golang的结构体","link":"/posts/关于指针与Golang的结构体"},"nextPost":{"title":"关于Golang程序的内存占用过大的问题","link":"/posts/关于Golang程序的内存占用过大的问题"},"headings":[]},"__N_SSG":true}