<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>看看是谁在D我</title><meta name="description" content="A personal blog about work and life"/><link rel="icon" href="/favicon.ico"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/8e9c96caf1d2c426.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8e9c96caf1d2c426.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-9b312e20a4e32339.js" defer=""></script><script src="/_next/static/chunks/framework-a87821de553db91d.js" defer=""></script><script src="/_next/static/chunks/main-fc7d2f0e2098927e.js" defer=""></script><script src="/_next/static/chunks/pages/_app-eda78b133ffb065e.js" defer=""></script><script src="/_next/static/chunks/814-5321687895e5b29b.js" defer=""></script><script src="/_next/static/chunks/73-7bff4760f20e3113.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-288bea1f51fd237c.js" defer=""></script><script src="/_next/static/5TLzpX8M238LC867IK7tS/_buildManifest.js" defer=""></script><script src="/_next/static/5TLzpX8M238LC867IK7tS/_ssgManifest.js" defer=""></script><script src="/_next/static/5TLzpX8M238LC867IK7tS/_middlewareManifest.js" defer=""></script><style data-styled="" data-styled-version="5.3.5">body{background:white;color:black;}/*!sc*/
data-styled.g1[id="sc-global-PuglZ1"]{content:"sc-global-PuglZ1,"}/*!sc*/
.bPeStA{width:24px;height:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;}/*!sc*/
data-styled.g2[id="sc-5cd0e2fd-0"]{content:"bPeStA,"}/*!sc*/
.gbzBzY{background:black;height:2px;-webkit-transition:all .3s;transition:all .3s;}/*!sc*/
.gbzBzY.is-close{opacity:0;}/*!sc*/
data-styled.g3[id="sc-5cd0e2fd-1"]{content:"gbzBzY,"}/*!sc*/
.cBbFCZ{height:2px;position:relative;}/*!sc*/
.cBbFCZ::before,.cBbFCZ::after{content:'';position:absolute;top:0;left:0;width:100%;height:2px;background:black;-webkit-transition:all .3s;transition:all .3s;}/*!sc*/
data-styled.g4[id="sc-5cd0e2fd-2"]{content:"cBbFCZ,"}/*!sc*/
.iGNOmR{background:white;position:fixed;width:100%;height:100%;z-index:10;-webkit-transform:translateY(0);-ms-transform:translateY(0);transform:translateY(0);-webkit-transition:-webkit-transform 1s cubic-bezier(0.46,0,0.08,1.11);-webkit-transition:transform 1s cubic-bezier(0.46,0,0.08,1.11);transition:transform 1s cubic-bezier(0.46,0,0.08,1.11);}/*!sc*/
.iGNOmR.hidden{-webkit-transform:translateY(-100%);-ms-transform:translateY(-100%);transform:translateY(-100%);}/*!sc*/
.iGNOmR h1{-webkit-text-stroke:1px;-webkit-text-fill-color:transparent;}/*!sc*/
.iGNOmR h1 span{position:relative;}/*!sc*/
.iGNOmR h1 span::after{content:'';position:absolute;left:0;bottom:-1rem;width:100%;height:1px;background:#ae8d0b;}/*!sc*/
data-styled.g5[id="sc-c82ddaac-0"]{content:"iGNOmR,"}/*!sc*/
.jEJavn{margin:0 auto;padding:92px 0px;text-align:center;font-weight:bold;}/*!sc*/
data-styled.g6[id="sc-c82ddaac-1"]{content:"jEJavn,"}/*!sc*/
.cihH{font-size:1.625rem;line-height:2.75rem;position:relative;-webkit-transition:box-shadow .3s ease;transition:box-shadow .3s ease;cursor:pointer;}/*!sc*/
.cihH:hover{box-shadow:inset 0 -0.5em 0 #ffffff55;-webkit-transform:scale(1.2);-ms-transform:scale(1.2);transform:scale(1.2);}/*!sc*/
data-styled.g7[id="sc-c82ddaac-2"]{content:"cihH,"}/*!sc*/
.gpZtOo{height:63px;width:100%;text-align:center;padding-top:0.625rem;font-size:14px;opacity:.6;}/*!sc*/
data-styled.g8[id="sc-dfe8bad9-0"]{content:"gpZtOo,"}/*!sc*/
.fPolhb{height:63px;width:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:fixed;background-color:white;z-index:10;-webkit-transform:translateY(0);-ms-transform:translateY(0);transform:translateY(0);-webkit-transition:-webkit-transform .5s ease;-webkit-transition:transform .5s ease;transition:transform .5s ease;}/*!sc*/
data-styled.g9[id="sc-dfe8bad9-1"]{content:"fPolhb,"}/*!sc*/
.cmGLcX{-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;text-align:right;font-size:0.875em;cursor:pointer;max-width:63px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}/*!sc*/
.cmGLcX > div{display:inline-block;margin-left:auto;margin-right:20px;height:20px;position:relative;}/*!sc*/
@media screen and (max-width:580px){.cmGLcX > div{margin-right:16px;padding:1px 0;}}/*!sc*/
data-styled.g10[id="sc-dfe8bad9-2"]{content:"cmGLcX,"}/*!sc*/
.iRSLCw{-webkit-flex:2 1 auto;-ms-flex:2 1 auto;flex:2 1 auto;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:space-evenly;-webkit-justify-content:space-evenly;-ms-flex-pack:space-evenly;justify-content:space-evenly;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}/*!sc*/
@media screen and (min-width:780px){.iRSLCw{max-width:50%;}}/*!sc*/
@media screen and (min-width:580px){.iRSLCw{max-width:390px;}}/*!sc*/
@media screen and (max-width:580px){.iRSLCw{max-width:290px;}}/*!sc*/
.iRSLCw ol{padding:0 .5em;padding-top:2px;}/*!sc*/
.iRSLCw a{position:relative;font-weight:500;}/*!sc*/
.iRSLCw a::before{content:'';position:absolute;left:0;bottom:-3px;width:0;height:2px;background:#ae8d0b;-webkit-transition:width 1s cubic-bezier(0.34,0.04,0.03,1.4),background .3s;transition:width 1s cubic-bezier(0.34,0.04,0.03,1.4),background .3s;}/*!sc*/
.iRSLCw a:hover::before{width:100%;}/*!sc*/
.iRSLCw ol.current a{color:#ae8d0b;}/*!sc*/
data-styled.g11[id="sc-dfe8bad9-3"]{content:"iRSLCw,"}/*!sc*/
.kVQNtT{-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;max-width:63px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}/*!sc*/
.kVQNtT img{margin-left:10px;z-index:11;width:63px;height:63px;float:left;cursor:pointer;}/*!sc*/
@media screen and (max-width:580px){.kVQNtT img{width:48px;height:48px;}}/*!sc*/
data-styled.g12[id="sc-dfe8bad9-4"]{content:"kVQNtT,"}/*!sc*/
.laVDHW{max-width:780px;margin:0 auto;padding:0 48px 48px 48px;}/*!sc*/
@media screen and (max-width:780px){.laVDHW{max-width:580px;}}/*!sc*/
@media screen and (max-width:580px){.laVDHW{padding:0 20px 48px 20px;}}/*!sc*/
data-styled.g17[id="sc-3b4733a1-0"]{content:"laVDHW,"}/*!sc*/
.jpHHIq{text-align:justify;}/*!sc*/
@media screen and (max-width:580px){.jpHHIq{text-align:unset;}}/*!sc*/
.jpHHIq img,.jpHHIq picture,.jpHHIq video,.jpHHIq canvas,.jpHHIq svg,.jpHHIq pre{margin:1.625rem 0;}/*!sc*/
.jpHHIq p,.jpHHIq ul,.jpHHIq ol{line-height:1.8rem;margin:1.125rem 0;}/*!sc*/
.jpHHIq blockquote{margin:1.625rem 0;}/*!sc*/
.jpHHIq a{position:relative;font-weight:600;}/*!sc*/
.jpHHIq a::before{content:'';position:absolute;left:0;bottom:-0.125em;width:100%;height:0;background:#00000022;border-bottom:1px solid gray;-webkit-transition:height .5s ease;transition:height .5s ease;}/*!sc*/
.jpHHIq a:hover::before{height:1.25em;}/*!sc*/
.jpHHIq code{background-color:#eeeeee;font-size:0.95rem;border-radius:3px;padding:0 0.25rem;margin:0 1px;}/*!sc*/
.jpHHIq pre code{font-size:0.875rem;border-radius:unset;padding:1rem 2rem;margin:unset;}/*!sc*/
.jpHHIq blockquote{border-left:solid 2px;padding-left:1.875em;color:#666666;}/*!sc*/
.jpHHIq del{opacity:.33;}/*!sc*/
.jpHHIq li{display:block;position:relative;}/*!sc*/
.jpHHIq li::before{content:'';position:absolute;top:.6em;height:.4em;width:.4em;border-radius:1em;border:solid 1px #ae8d0b;left:-1.5rem;}/*!sc*/
data-styled.g34[id="sc-3a0233ea-0"]{content:"jpHHIq,"}/*!sc*/
.jEknbu{max-width:750px;margin:72px auto;}/*!sc*/
data-styled.g40[id="sc-2cae1911-0"]{content:"jEknbu,"}/*!sc*/
.iHkyQR{margin-bottom:3rem;}/*!sc*/
.iHkyQR h1{margin-top:.3rem;margin-bottom:0.5rem;}/*!sc*/
data-styled.g41[id="sc-2cae1911-1"]{content:"iHkyQR,"}/*!sc*/
.jcpvXn{font-size:0.875rem;position:relative;}/*!sc*/
.jcpvXn::before{content:'';position:absolute;top:-.8em;left:0;height:1px;width:133%;background:#ae8d0b;}/*!sc*/
data-styled.g42[id="sc-2cae1911-2"]{content:"jcpvXn,"}/*!sc*/
.jYfjbC{color:#666666;-webkit-transition:opacity .3s,color .3s;transition:opacity .3s,color .3s;}/*!sc*/
.jYfjbC:hover{color:#ae8d0b;}/*!sc*/
data-styled.g43[id="sc-2cae1911-3"]{content:"jYfjbC,"}/*!sc*/
.lgdBbT{box-shadow:inset 0 -0.3em 0 #00000022;-webkit-transition:box-shadow 0.5s ease;transition:box-shadow 0.5s ease;}/*!sc*/
.lgdBbT:hover{box-shadow:inset 0 -1em 0 #00000022;}/*!sc*/
data-styled.g44[id="sc-2cae1911-4"]{content:"lgdBbT,"}/*!sc*/
</style></head><body><div id="__next"><div class="sc-c82ddaac-0 iGNOmR hidden"><div style="padding-top:8rem" class="sc-c82ddaac-1 jEJavn"><h1><span>SANSUI&#x27;S BLOG</span></h1><div><span style="font-size:1.625rem" class="sc-c82ddaac-2 cihH">日间模式</span></div><div><span class="sc-c82ddaac-2 cihH"><a href="/categories">分类</a></span></div><div><span class="sc-c82ddaac-2 cihH"><a href="/atom.xml">RSS</a></span></div><p style="padding-top:2em">持续完善中</p><p>Sansui 2022 All rights reserved</p></div></div><header class="sc-dfe8bad9-1 fPolhb"><div class="sc-dfe8bad9-4 kVQNtT"><a href="/"><img src="/avatar-white.png" alt="Sansui"/></a></div><nav class="sc-dfe8bad9-3 iRSLCw"><ol class=""><a href="/">Posts</a></ol><ol class=""><a href="/memos">Memos</a></ol><ol class=""><a href="/about">About</a></ol></nav><div class="sc-dfe8bad9-2 cmGLcX"><div><div width="24" class="sc-5cd0e2fd-0 bPeStA"><div class="sc-5cd0e2fd-1 gbzBzY"></div><div class="sc-5cd0e2fd-2 cBbFCZ"></div><div class="sc-5cd0e2fd-1 gbzBzY"></div></div></div></div></header><div class="sc-dfe8bad9-0 gpZtOo">- 人活着就是为了卡卡西 -</div><main><div class="sc-3b4733a1-0 sc-2cae1911-0 laVDHW jEknbu"><div class="sc-2cae1911-1 iHkyQR"><h1>看看是谁在D我</h1><span class="sc-2cae1911-2 jcpvXn">2020-12-12<!-- --> | <!-- --><a href="/tags/%E8%BF%90%E7%BB%B4" class="sc-2cae1911-3 jYfjbC">#运维 </a><a href="/tags/nginx" class="sc-2cae1911-3 jYfjbC">#nginx </a><a href="/tags/Linux" class="sc-2cae1911-3 jYfjbC">#Linux </a> in <!-- --><a href="/categories/%E6%8A%98%E8%85%BE" class="sc-2cae1911-4 lgdBbT">折腾</a></span></div><div class="sc-3a0233ea-0 jpHHIq"><p>自从部署了服务器，一直都觉得访问量不太正常。但我也仅仅是对IP做了防护，CDN防火墙也没怎么设置。</p>
<!-- --><p>直到最近觉得，天天访问上万，唯一IP数却一千不到，cache率更是一直都在1%以下。决定看看是哪些人（IP）干的事，服务器实在不值得。</p>
<!-- --><h2>查看ip访问行为</h2>
<!-- --><p>web服务器使用的nginx，由于CDN的关系，nginx需要有http-realip的模块才能查看CDN前的ip。找了不少资料就只觉得这个文章不错，废话少过程清晰，还很贴心给了生成脚本（和我流爱说废话自言自语的风格完全不同）</p>
<!-- --><blockquote>
<!-- --><p><a href="https://www.nenew.net/cloudflare-cdn-nginx-get-real-ip-tutorial.html">CloudFlare CDN下Nginx正确获取真实IP教程</a></p>
<!-- --></blockquote>
<!-- --><p>配置完成后运行了一段时间。先统计下当前的log文件前10名的访问量和相应ip：</p>
<!-- --><pre><code class="language-bash">$ cat access.log | awk &#x27;{print $1}&#x27;| sort -n | uniq -c | sort -n -r | head -10

    979 103.242.119.217
    285 1.163.108.18
    204 18.166.211.38
    176 184.170.243.198
    154 66.98.113.44
    149 40.65.134.91
    116 2400:8902::f03c:92ff:fe7b:5f02
    113 113.71.61.213
     92 185.245.1.151
     80 107.148.250.111
</code></pre>
<!-- --><p>第一名， <!-- --><code>103.242.119.217</code> ，979次？这多得也太夸张了？！<!-- --></p>
<!-- --><p>好吧，来看看这个ip在干什么。</p>
<!-- --><pre><code class="language-bash">$ cat access.log | grep 103.242.119.217 | tail -n 20
103.242.119.217 - - [10/Dec/2020:08:54:41 +0000] &quot;GET /WWW/phpMyAdmin/index.php HTTP/1.1&quot; 404 178 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0&quot;
103.242.119.217 - - [10/Dec/2020:08:54:41 +0000] &quot;GET /phpMyAdmln/index.php HTTP/1.1&quot; 404 178 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0&quot;
103.242.119.217 - - [10/Dec/2020:08:54:41 +0000] &quot;GET /phpMyAdmin_ai/index.php HTTP/1.1&quot; 404 178 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0&quot;
103.242.119.217 - - [10/Dec/2020:08:54:41 +0000] &quot;GET /__phpMyAdmin/index.php HTTP/1.1&quot; 404 178 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0&quot;
103.242.119.217 - - [10/Dec/2020:08:54:42 +0000] &quot;GET /program/index.php HTTP/1.1&quot; 404 178 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0&quot;
103.242.119.217 - - [10/Dec/2020:08:54:42 +0000] &quot;GET /shopdb/index.php HTTP/1.1&quot; 404 178 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0&quot;
103.242.119.217 - - [10/Dec/2020:08:54:42 +0000] &quot;GET /phppma/index.php HTTP/1.1&quot; 404 178 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0&quot;
103.242.119.217 - - [10/Dec/2020:08:54:42 +0000] &quot;GET /phpmy/index.php HTTP/1.1&quot; 404 178 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0&quot;
103.242.119.217 - - [10/Dec/2020:08:54:43 +0000] &quot;GET /mysql/admin/index.php HTTP/1.1&quot; 404 178 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0&quot;
103.242.119.217 - - [10/Dec/2020:08:54:43 +0000] &quot;GET /mysql/dbadmin/index.php HTTP/1.1&quot; 404 178 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0&quot;
103.242.119.217 - - [10/Dec/2020:08:54:43 +0000] &quot;GET /mysql/sqlmanager/index.php HTTP/1.1&quot; 404 178 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0&quot;
103.242.119.217 - - [10/Dec/2020:08:54:43 +0000] &quot;GET /mysql/mysqlmanager/index.php HTTP/1.1&quot; 404 178 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0&quot;
103.242.119.217 - - [10/Dec/2020:08:54:44 +0000] &quot;GET /wp-content/plugins/portable-phpmyadmin/wp-pma-mod/index.php HTTP/1.1&quot; 404 178 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0&quot;
103.242.119.217 - - [10/Dec/2020:08:54:44 +0000] &quot;GET /sqladmin/index.php HTTP/1.1&quot; 404 178 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0&quot;
103.242.119.217 - - [10/Dec/2020:08:54:44 +0000] &quot;GET /sql/index.php HTTP/1.1&quot; 404 178 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0&quot;
...
</code></pre>
<!-- --><p>…………尼玛，恶意扫描啊！扫描常用路由啊碰运气啊！人干事？</p>
<!-- --><p>但估计这种恶意扫描的也是日抛ip，ban也没什么意义。只能设置limit rate了。</p>
<!-- --><p>看看第二名在干什么。</p>
<!-- --><pre><code class="language-bash">$ cat access.log | grep 1.163.108.18 | tail -n 10
1.163.108.18 - - [10/Dec/2020:10:15:38 +0000] &quot;GET /clash/config HTTP/1.1&quot; 200 4978 &quot;-&quot; &quot;ClashforWindows/0.13.1&quot;
1.163.108.18 - - [10/Dec/2020:10:16:36 +0000] &quot;GET /clash/config HTTP/1.1&quot; 200 4978 &quot;-&quot; &quot;ClashforWindows/0.13.1&quot;
1.163.108.18 - - [10/Dec/2020:10:17:36 +0000] &quot;GET /clash/config HTTP/1.1&quot; 200 4978 &quot;-&quot; &quot;ClashforWindows/0.13.1&quot;
1.163.108.18 - - [10/Dec/2020:10:18:31 +0000] &quot;GET /clash/config HTTP/1.1&quot; 200 4978 &quot;-&quot; &quot;ClashforWindows/0.13.1&quot;
1.163.108.18 - - [10/Dec/2020:10:19:32 +0000] &quot;GET /clash/config HTTP/1.1&quot; 200 4978 &quot;-&quot; &quot;ClashforWindows/0.13.1&quot;
1.163.108.18 - - [10/Dec/2020:10:20:35 +0000] &quot;GET /clash/config HTTP/1.1&quot; 200 4978 &quot;-&quot; &quot;ClashforWindows/0.13.1&quot;
1.163.108.18 - - [10/Dec/2020:10:21:30 +0000] &quot;GET /clash/config HTTP/1.1&quot; 200 4978 &quot;-&quot; &quot;ClashforWindows/0.13.1&quot;
1.163.108.18 - - [10/Dec/2020:10:22:34 +0000] &quot;GET /clash/config HTTP/1.1&quot; 200 4978 &quot;-&quot; &quot;ClashforWindows/0.13.1&quot;
1.163.108.18 - - [10/Dec/2020:10:23:36 +0000] &quot;GET /clash/config HTTP/1.1&quot; 200 4978 &quot;-&quot; &quot;ClashforWindows/0.13.1&quot;
1.163.108.18 - - [10/Dec/2020:10:24:32 +0000] &quot;GET /clash/config HTTP/1.1&quot; 200 4978 &quot;-&quot; &quot;ClashforWindows/0.13.1&quot;
</code></pre>
<!-- --><p>这应该是个用户吧，但你这更新就更新吧，每分钟更新一次？能不能积点德？（哽塞.jpg）</p>
<!-- --><p>消耗流量都是其次，也并没有多出很多。但我不喜欢泡沫和虚高的数值，也讨厌因为不用付出成本所以极其浪费资源的做法，于我而言就像房间堆满了垃圾。看起来好像有很多东西，实际上什么也没有。</p>
<!-- --><p>要是我这种心态，创业肯定找不到风投，很快就倒闭。</p>
<!-- --><p>这些IP ban了也不太好……开个Challenge吧。</p>
<!-- --><p>顺带一提，默认配置文件的更新间隔早就给取消了。取消的原因倒不是怕被D，当时还完全没想过会租服务器，只是单纯的因为程序会有各种意想不到的BUG，时不时出现全NULL，连之前能用的都没有了……自动更新太容易挂掉，于是取消了自动更新。</p>
<!-- --><p>然后继续看，从第2名到第8名都是这种行为。我说呢，今天从浏览器进入的配置文件的页面一直无法加载，但服务端不管怎么请求都没有问题，最后不得已换成了一个静态文件。敢情就是你们搞没的？</p>
<!-- --><p>再加上gin的静态cache本身就不太稳。之前使用css的时候基本运行3天就外链请求不出来了，最后也是用nginx挂的静态文件。</p>
<!-- --><p>第7名到第10名，很明显，同类程序的爬虫。Duang地一下请求几个一般人不用的链接。对于这些爬虫我觉得倒还行，请求频率并不会太高。但非常不喜欢直接伸手全爬别人爬好的，这是极其恶劣的生态与shame的想法。爬虫的理想的状态是网状分布式的部署，而不是树。</p>
<!-- --><h2>防护措施</h2>
<!-- --><p>由于挂了CloudFlare，iptables自然没什么用，还容易不小心把CF的IP ban掉（虽然在发现这一点之前我折腾了快一下午的iptables）。直接去配置CF的防火墙。</p>
<!-- --><p>我需要应对的情况主要就这一个：</p>
<!-- --><ul>
<!-- --><li>一分钟更新一次配置文件的ip，给他们一个小小的JS Chanllenge</li>
<!-- --></ul>
<!-- --><p>（突然有点后悔写了JS Chanllenge的破解是什么回事……）</p>
<!-- --><p>但是啊，这些ip还是不少活人的，长期都Chanllenge没有必要。而且我也不能天天都像今天这么看log，实在是消耗时间，消耗时间就是生命。</p>
<!-- --><p>而Nginx和CloudFlare的rate limit都是防止CC，限制的每秒或者每分钟的请求数。但这恰恰是我不能做的，默认的配置文件的写法1s内会请求十几次，多请求几次就一分钟就几十次了（配置文件该改改了）。我需要处理的是过于规律且相对频繁的请求，而非CC。</p>
<!-- --><p>于是连夜写了个分析log的程序，主要是以下功能：</p>
<!-- --><ul>
<!-- --><li>根据请求间隔的规律判断是否为需要处理的ip
特征：<!-- -->
<!-- --><ul>
<!-- --><li>请求间隔过于规律，比如每分钟一次、每分钟两次等等。有容错率。</li>
<!-- --><li>不计算大于 <!-- --><code>threshold</code> 分钟的间隔与等于0分钟的间隔。<!-- --></li>
<!-- --></ul>
<!-- --></li>
<!-- --><li>排除CloudFlare子网下的IP。CloudFlare的ip网段在线获取。</li>
<!-- --><li>使用CloudFlare Api更新JS Chanllenge的filter，给需要过滤的ip加上Challenge</li>
<!-- --></ul>
<!-- --><p>然后用cron定时执行。常驻后台没必要，也没想做实时监控，</p>
<!-- --><p>把恶意IP和常见的IP过滤掉后，最新的就只剩下CloudFlare的请求了，终于干净了……但好寂寞啊…………看来是真的没什么活人用呢。</p>
<!-- --><h2>一天后</h2>
<!-- --><p>今天的Requests数是17435。</p>
<!-- --><p>Unique Request是1188。</p>
<!-- --><p>Challenge挑战的Request数是，8200（微笑脸）。</p>
<!-- --><p>你妹啊，Bot一样的自动更新占了快一半啊！摔！</p>
<!-- --><p>而且每次防火墙每次更新过滤的ip都是那么40个左右，Challenge通过率是0.5%。</p>
<!-- --><p>40ip个会不会有点多？是不是程序有问题？我开始也这么想过，但我自己也设置有定时更新，还设置了三份，都没见把我自己ban掉。</p>
<!-- --><p>累了，感觉不再爱了。</p></div></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"mdxSource":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, {})\n  })) : _createMdxContent();\n  function _createMdxContent() {\n    const _components = Object.assign({\n      p: \"p\",\n      h2: \"h2\",\n      blockquote: \"blockquote\",\n      a: \"a\",\n      pre: \"pre\",\n      code: \"code\",\n      ul: \"ul\",\n      li: \"li\"\n    }, _provideComponents(), props.components);\n    return _jsxs(_Fragment, {\n      children: [_jsx(_components.p, {\n        children: \"自从部署了服务器，一直都觉得访问量不太正常。但我也仅仅是对IP做了防护，CDN防火墙也没怎么设置。\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"直到最近觉得，天天访问上万，唯一IP数却一千不到，cache率更是一直都在1%以下。决定看看是哪些人（IP）干的事，服务器实在不值得。\"\n      }), \"\\n\", _jsx(_components.h2, {\n        children: \"查看ip访问行为\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"web服务器使用的nginx，由于CDN的关系，nginx需要有http-realip的模块才能查看CDN前的ip。找了不少资料就只觉得这个文章不错，废话少过程清晰，还很贴心给了生成脚本（和我流爱说废话自言自语的风格完全不同）\"\n      }), \"\\n\", _jsxs(_components.blockquote, {\n        children: [\"\\n\", _jsx(_components.p, {\n          children: _jsx(_components.a, {\n            href: \"https://www.nenew.net/cloudflare-cdn-nginx-get-real-ip-tutorial.html\",\n            children: \"CloudFlare CDN下Nginx正确获取真实IP教程\"\n          })\n        }), \"\\n\"]\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"配置完成后运行了一段时间。先统计下当前的log文件前10名的访问量和相应ip：\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"language-bash\",\n          children: \"$ cat access.log | awk '{print $1}'| sort -n | uniq -c | sort -n -r | head -10\\n\\n    979 103.242.119.217\\n    285 1.163.108.18\\n    204 18.166.211.38\\n    176 184.170.243.198\\n    154 66.98.113.44\\n    149 40.65.134.91\\n    116 2400:8902::f03c:92ff:fe7b:5f02\\n    113 113.71.61.213\\n     92 185.245.1.151\\n     80 107.148.250.111\\n\"\n        })\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"第一名， \", _jsx(_components.code, {\n          children: \"103.242.119.217\"\n        }), \" ，979次？这多得也太夸张了？！\"]\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"好吧，来看看这个ip在干什么。\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"language-bash\",\n          children: \"$ cat access.log | grep 103.242.119.217 | tail -n 20\\n103.242.119.217 - - [10/Dec/2020:08:54:41 +0000] \\\"GET /WWW/phpMyAdmin/index.php HTTP/1.1\\\" 404 178 \\\"-\\\" \\\"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0\\\"\\n103.242.119.217 - - [10/Dec/2020:08:54:41 +0000] \\\"GET /phpMyAdmln/index.php HTTP/1.1\\\" 404 178 \\\"-\\\" \\\"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0\\\"\\n103.242.119.217 - - [10/Dec/2020:08:54:41 +0000] \\\"GET /phpMyAdmin_ai/index.php HTTP/1.1\\\" 404 178 \\\"-\\\" \\\"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0\\\"\\n103.242.119.217 - - [10/Dec/2020:08:54:41 +0000] \\\"GET /__phpMyAdmin/index.php HTTP/1.1\\\" 404 178 \\\"-\\\" \\\"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0\\\"\\n103.242.119.217 - - [10/Dec/2020:08:54:42 +0000] \\\"GET /program/index.php HTTP/1.1\\\" 404 178 \\\"-\\\" \\\"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0\\\"\\n103.242.119.217 - - [10/Dec/2020:08:54:42 +0000] \\\"GET /shopdb/index.php HTTP/1.1\\\" 404 178 \\\"-\\\" \\\"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0\\\"\\n103.242.119.217 - - [10/Dec/2020:08:54:42 +0000] \\\"GET /phppma/index.php HTTP/1.1\\\" 404 178 \\\"-\\\" \\\"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0\\\"\\n103.242.119.217 - - [10/Dec/2020:08:54:42 +0000] \\\"GET /phpmy/index.php HTTP/1.1\\\" 404 178 \\\"-\\\" \\\"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0\\\"\\n103.242.119.217 - - [10/Dec/2020:08:54:43 +0000] \\\"GET /mysql/admin/index.php HTTP/1.1\\\" 404 178 \\\"-\\\" \\\"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0\\\"\\n103.242.119.217 - - [10/Dec/2020:08:54:43 +0000] \\\"GET /mysql/dbadmin/index.php HTTP/1.1\\\" 404 178 \\\"-\\\" \\\"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0\\\"\\n103.242.119.217 - - [10/Dec/2020:08:54:43 +0000] \\\"GET /mysql/sqlmanager/index.php HTTP/1.1\\\" 404 178 \\\"-\\\" \\\"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0\\\"\\n103.242.119.217 - - [10/Dec/2020:08:54:43 +0000] \\\"GET /mysql/mysqlmanager/index.php HTTP/1.1\\\" 404 178 \\\"-\\\" \\\"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0\\\"\\n103.242.119.217 - - [10/Dec/2020:08:54:44 +0000] \\\"GET /wp-content/plugins/portable-phpmyadmin/wp-pma-mod/index.php HTTP/1.1\\\" 404 178 \\\"-\\\" \\\"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0\\\"\\n103.242.119.217 - - [10/Dec/2020:08:54:44 +0000] \\\"GET /sqladmin/index.php HTTP/1.1\\\" 404 178 \\\"-\\\" \\\"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0\\\"\\n103.242.119.217 - - [10/Dec/2020:08:54:44 +0000] \\\"GET /sql/index.php HTTP/1.1\\\" 404 178 \\\"-\\\" \\\"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0\\\"\\n...\\n\"\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"…………尼玛，恶意扫描啊！扫描常用路由啊碰运气啊！人干事？\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"但估计这种恶意扫描的也是日抛ip，ban也没什么意义。只能设置limit rate了。\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"看看第二名在干什么。\"\n      }), \"\\n\", _jsx(_components.pre, {\n        children: _jsx(_components.code, {\n          className: \"language-bash\",\n          children: \"$ cat access.log | grep 1.163.108.18 | tail -n 10\\n1.163.108.18 - - [10/Dec/2020:10:15:38 +0000] \\\"GET /clash/config HTTP/1.1\\\" 200 4978 \\\"-\\\" \\\"ClashforWindows/0.13.1\\\"\\n1.163.108.18 - - [10/Dec/2020:10:16:36 +0000] \\\"GET /clash/config HTTP/1.1\\\" 200 4978 \\\"-\\\" \\\"ClashforWindows/0.13.1\\\"\\n1.163.108.18 - - [10/Dec/2020:10:17:36 +0000] \\\"GET /clash/config HTTP/1.1\\\" 200 4978 \\\"-\\\" \\\"ClashforWindows/0.13.1\\\"\\n1.163.108.18 - - [10/Dec/2020:10:18:31 +0000] \\\"GET /clash/config HTTP/1.1\\\" 200 4978 \\\"-\\\" \\\"ClashforWindows/0.13.1\\\"\\n1.163.108.18 - - [10/Dec/2020:10:19:32 +0000] \\\"GET /clash/config HTTP/1.1\\\" 200 4978 \\\"-\\\" \\\"ClashforWindows/0.13.1\\\"\\n1.163.108.18 - - [10/Dec/2020:10:20:35 +0000] \\\"GET /clash/config HTTP/1.1\\\" 200 4978 \\\"-\\\" \\\"ClashforWindows/0.13.1\\\"\\n1.163.108.18 - - [10/Dec/2020:10:21:30 +0000] \\\"GET /clash/config HTTP/1.1\\\" 200 4978 \\\"-\\\" \\\"ClashforWindows/0.13.1\\\"\\n1.163.108.18 - - [10/Dec/2020:10:22:34 +0000] \\\"GET /clash/config HTTP/1.1\\\" 200 4978 \\\"-\\\" \\\"ClashforWindows/0.13.1\\\"\\n1.163.108.18 - - [10/Dec/2020:10:23:36 +0000] \\\"GET /clash/config HTTP/1.1\\\" 200 4978 \\\"-\\\" \\\"ClashforWindows/0.13.1\\\"\\n1.163.108.18 - - [10/Dec/2020:10:24:32 +0000] \\\"GET /clash/config HTTP/1.1\\\" 200 4978 \\\"-\\\" \\\"ClashforWindows/0.13.1\\\"\\n\"\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"这应该是个用户吧，但你这更新就更新吧，每分钟更新一次？能不能积点德？（哽塞.jpg）\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"消耗流量都是其次，也并没有多出很多。但我不喜欢泡沫和虚高的数值，也讨厌因为不用付出成本所以极其浪费资源的做法，于我而言就像房间堆满了垃圾。看起来好像有很多东西，实际上什么也没有。\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"要是我这种心态，创业肯定找不到风投，很快就倒闭。\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"这些IP ban了也不太好……开个Challenge吧。\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"顺带一提，默认配置文件的更新间隔早就给取消了。取消的原因倒不是怕被D，当时还完全没想过会租服务器，只是单纯的因为程序会有各种意想不到的BUG，时不时出现全NULL，连之前能用的都没有了……自动更新太容易挂掉，于是取消了自动更新。\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"然后继续看，从第2名到第8名都是这种行为。我说呢，今天从浏览器进入的配置文件的页面一直无法加载，但服务端不管怎么请求都没有问题，最后不得已换成了一个静态文件。敢情就是你们搞没的？\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"再加上gin的静态cache本身就不太稳。之前使用css的时候基本运行3天就外链请求不出来了，最后也是用nginx挂的静态文件。\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"第7名到第10名，很明显，同类程序的爬虫。Duang地一下请求几个一般人不用的链接。对于这些爬虫我觉得倒还行，请求频率并不会太高。但非常不喜欢直接伸手全爬别人爬好的，这是极其恶劣的生态与shame的想法。爬虫的理想的状态是网状分布式的部署，而不是树。\"\n      }), \"\\n\", _jsx(_components.h2, {\n        children: \"防护措施\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"由于挂了CloudFlare，iptables自然没什么用，还容易不小心把CF的IP ban掉（虽然在发现这一点之前我折腾了快一下午的iptables）。直接去配置CF的防火墙。\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"我需要应对的情况主要就这一个：\"\n      }), \"\\n\", _jsxs(_components.ul, {\n        children: [\"\\n\", _jsx(_components.li, {\n          children: \"一分钟更新一次配置文件的ip，给他们一个小小的JS Chanllenge\"\n        }), \"\\n\"]\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"（突然有点后悔写了JS Chanllenge的破解是什么回事……）\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"但是啊，这些ip还是不少活人的，长期都Chanllenge没有必要。而且我也不能天天都像今天这么看log，实在是消耗时间，消耗时间就是生命。\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"而Nginx和CloudFlare的rate limit都是防止CC，限制的每秒或者每分钟的请求数。但这恰恰是我不能做的，默认的配置文件的写法1s内会请求十几次，多请求几次就一分钟就几十次了（配置文件该改改了）。我需要处理的是过于规律且相对频繁的请求，而非CC。\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"于是连夜写了个分析log的程序，主要是以下功能：\"\n      }), \"\\n\", _jsxs(_components.ul, {\n        children: [\"\\n\", _jsxs(_components.li, {\n          children: [\"根据请求间隔的规律判断是否为需要处理的ip\\n特征：\", \"\\n\", _jsxs(_components.ul, {\n            children: [\"\\n\", _jsx(_components.li, {\n              children: \"请求间隔过于规律，比如每分钟一次、每分钟两次等等。有容错率。\"\n            }), \"\\n\", _jsxs(_components.li, {\n              children: [\"不计算大于 \", _jsx(_components.code, {\n                children: \"threshold\"\n              }), \" 分钟的间隔与等于0分钟的间隔。\"]\n            }), \"\\n\"]\n          }), \"\\n\"]\n        }), \"\\n\", _jsx(_components.li, {\n          children: \"排除CloudFlare子网下的IP。CloudFlare的ip网段在线获取。\"\n        }), \"\\n\", _jsx(_components.li, {\n          children: \"使用CloudFlare Api更新JS Chanllenge的filter，给需要过滤的ip加上Challenge\"\n        }), \"\\n\"]\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"然后用cron定时执行。常驻后台没必要，也没想做实时监控，\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"把恶意IP和常见的IP过滤掉后，最新的就只剩下CloudFlare的请求了，终于干净了……但好寂寞啊…………看来是真的没什么活人用呢。\"\n      }), \"\\n\", _jsx(_components.h2, {\n        children: \"一天后\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"今天的Requests数是17435。\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Unique Request是1188。\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Challenge挑战的Request数是，8200（微笑脸）。\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"你妹啊，Bot一样的自动更新占了快一半啊！摔！\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"而且每次防火墙每次更新过滤的ip都是那么40个左右，Challenge通过率是0.5%。\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"40ip个会不会有点多？是不是程序有问题？我开始也这么想过，但我自己也设置有定时更新，还设置了三份，都没见把我自己ban掉。\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"累了，感觉不再爱了。\"\n      })]\n    });\n  }\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{"title":"看看是谁在D我","date":"2020-12-12","categories":"折腾","tags":["运维","nginx","Linux"]},"scope":{}}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"看看是谁在D我"},"buildId":"5TLzpX8M238LC867IK7tS","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>